<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hello, World" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="&amp;#x6587;&amp;#x4EF6;&amp;#x7ED3;&amp;#x6784;&amp;#xFF1A;utils.py&amp;#x4E2D;&amp;#x5B9A;&amp;#x4E49;&amp;#x7684;&amp;#x662F;&amp;#x4E9B; General Utilities&amp;#xFF0C;&amp;#x901A;&amp;#x7528;&amp;#x5DE5;&amp;#x5177;&amp;#x96C6;&amp;#x548C;&amp;#x6570;&amp;#x636E;&amp;#x7ED3;&amp;#x678">
<meta property="og:type" content="article">
<meta property="og:title" content="web.py源码(持续更新)">
<meta property="og:url" content="http://notes.zhouping.xin/2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/index.html">
<meta property="og:site_name" content="Chow's Notes">
<meta property="og:description" content="&amp;#x6587;&amp;#x4EF6;&amp;#x7ED3;&amp;#x6784;&amp;#xFF1A;utils.py&amp;#x4E2D;&amp;#x5B9A;&amp;#x4E49;&amp;#x7684;&amp;#x662F;&amp;#x4E9B; General Utilities&amp;#xFF0C;&amp;#x901A;&amp;#x7528;&amp;#x5DE5;&amp;#x5177;&amp;#x96C6;&amp;#x548C;&amp;#x6570;&amp;#x636E;&amp;#x7ED3;&amp;#x678">
<meta property="og:image" content="http://www.zhouping.xin/wp-content/uploads/2016/04/ContractedBlock-1.gif">
<meta property="og:image" content="http://www.zhouping.xin/wp-content/uploads/2016/04/ExpandedBlockStart-1.gif">
<meta property="og:image" content="http://www.zhouping.xin/wp-content/uploads/2016/04/ContractedBlock-1.gif">
<meta property="og:image" content="http://www.zhouping.xin/wp-content/uploads/2016/04/ExpandedBlockStart-1.gif">
<meta property="og:updated_time" content="2016-12-30T16:03:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="web.py源码(持续更新)">
<meta name="twitter:description" content="&amp;#x6587;&amp;#x4EF6;&amp;#x7ED3;&amp;#x6784;&amp;#xFF1A;utils.py&amp;#x4E2D;&amp;#x5B9A;&amp;#x4E49;&amp;#x7684;&amp;#x662F;&amp;#x4E9B; General Utilities&amp;#xFF0C;&amp;#x901A;&amp;#x7528;&amp;#x5DE5;&amp;#x5177;&amp;#x96C6;&amp;#x548C;&amp;#x6570;&amp;#x636E;&amp;#x7ED3;&amp;#x678">
<meta name="twitter:image" content="http://www.zhouping.xin/wp-content/uploads/2016/04/ContractedBlock-1.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: false,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://notes.zhouping.xin/2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/"/>





  <title> web.py源码(持续更新) | Chow's Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Chow's Notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description"></h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://notes.zhouping.xin/2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Chow">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar-zp.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Chow's Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Chow's Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                web.py源码(持续更新)
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-12-17T14:04:00+08:00">
                2014-12-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#xFF1A;<br>utils.py&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x662F;&#x4E9B; General Utilities&#xFF0C;&#x901A;&#x7528;&#x5DE5;&#x5177;&#x96C6;&#x548C;&#x6570;&#x636E;&#x7ED3;&#x6784;</p>
<p>1.<strong>&#x5BF9;&#x5E8F;&#x5217;&#x8FDB;&#x884C;&#x5206;&#x7EC4;&#x7684;&#x51FD;&#x6570;&#xFF08;&#x751F;&#x6210;&#x5668;&#x7684;&#x5F88;&#x597D;&#x4F7F;&#x7528;&#xFF0C;&#x503C;&#x5F97;&#x501F;&#x9274;&#xFF09;group</strong></p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> group(seq, size):<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> take(seq, n):<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">for</span> i <span style="color: #0000ff;">in</span><span style="color: #000000;"> xrange(n):<br></span><span style="color: #008080;"> 5</span>             <span style="color: #0000ff;">yield</span><span style="color: #000000;"> seq.next()<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> hasattr(seq, <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">next</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">):<br></span><span style="color: #008080;"> 8</span>         seq =<span style="color: #000000;"> iter(seq)<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">while</span><span style="color: #000000;"> True:<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>         inger=<span style="color: #000000;">take(seq, size)<br></span><span style="color: #008080;">13</span>         x =<span style="color: #000000;"> list(inger)<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> x:<br></span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">yield</span><span style="color: #000000;"> x<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">else</span><span style="color: #000000;">:<br></span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">break<br>/<em>&#x91CD;&#x70B9;&#x5728;take&#x751F;&#x6210;&#x5668;,&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x540E;seq&#x4F1A;&#x505C;&#x7559;&#x5728;&#x7684;&#x4E0A;&#x6B21;&#x8FED;&#x4EE3;n&#x6B21;seq&#x7ED3;&#x675F;&#x7684;seq[n]&#x5904;&#xFF0C;&#x56E0;&#x4E3A;seq&#x88AB;&#x8F6C;&#x6362;&#x6210;&#x4E86;&#x8FED;&#x4EE3;&#x5668;&#xFF0C;next&#x4F1A;&#x4E00;&#x76F4;&#x6709;&#x6548;&#x76F4;&#x5230;&#x6240;&#x6709;&#x5143;&#x7D20;&#x8FED;&#x4EE3;&#x5B8C;&#x4E3A;&#x6B62;,<br>&#x628A;&#x751F;&#x6210;&#x5668;&#x8F6C;&#x6362;&#x6210;&#x5217;&#x8868;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x4E5F;&#x662F;&#x8C03;&#x7528;next,&#x76F4;&#x5230;&#x629B;&#x51FA;StopIteration&#x5F02;&#x5E38;&#xFF0C;&#x88AB;list&#x6355;&#x83B7;</em>/</span></pre><br>&#xA0;</p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> take(seq, n):<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">for</span> i <span style="color: #0000ff;">in</span><span style="color: #000000;"> xrange(n):<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">yield</span><span style="color: #000000;"> seq.next()<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">#</span><span style="color: #008000;">while True:</span><br><span style="color: #008080;"> 6</span> <span style="color: #008000;">#</span><span style="color: #008000;">    inger=take(seq,2)</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">#</span><span style="color: #008000;">    import time</span><br><span style="color: #008080;"> 8</span> <span style="color: #008000;">#</span><span style="color: #008000;">    time.sleep(1)</span><br><span style="color: #008080;"> 9</span> <span style="color: #008000;">#</span><span style="color: #008000;">    print list(inger) #&#x8FED;&#x4EE3;&#x5230;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5F02;&#x5E38;&#x88AB;&#x6355;&#x83B7;</span><br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> res=take(seq,2<span style="color: #000000;">)<br></span><span style="color: #008080;">12</span> <span style="color: #008000;">#</span><span style="color: #008000;">print list(res)</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">print</span><span style="color: #000000;"> res.next()<br></span><span style="color: #008080;">14</span> <span style="color: #0000ff;">print</span><span style="color: #000000;"> res.next()<br></span><span style="color: #008080;">15</span> res=take(seq,2<span style="color: #000000;">)<br></span><span style="color: #008080;">16</span> <span style="color: #008000;">#</span><span style="color: #008000;">print list(res)</span><br><span style="color: #008080;">17</span> <span style="color: #0000ff;">print</span><span style="color: #000000;"> res.next()<br></span><span style="color: #008080;">18</span> <span style="color: #0000ff;">print</span><span style="color: #000000;"> res.next()<br></span><span style="color: #008080;">19</span> res=take(seq,2<span style="color: #000000;">)<br></span><span style="color: #008080;">20</span> <span style="color: #008000;">#</span><span style="color: #008000;">print list(res)</span><br><span style="color: #008080;">21</span> <span style="color: #0000ff;">print</span><span style="color: #000000;"> res.next()<br></span><span style="color: #008080;">22</span> <span style="color: #0000ff;">print</span> res.next() <span style="color: #008000;">#</span><span style="color: #008000;">StopIteration,&#x88AB;list&#x6355;&#x83B7;</span></pre><br></p>
<p><pre></pre></p>
<p><div class="cnblogs_code"></div></p>
<p><pre></pre></p>
<p><pre>#web.py-0.111&#x4E2D;&#x7684;&#x5B9E;&#x73B0;&#x4E0D;&#x80FD;&#xFF0C;&#x5206;&#x51FA;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x5143;&#x7D20;</pre></p>
<p><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> group(seq, size):<br></span><span style="color: #008080;"> 2</span>     <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><span style="color: #800000;">Breaks &#x2018;seq&#x2019; into a generator of lists with length &#x2018;size&#x2019;.</span><span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> hasattr(seq, <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">next</span><span style="color: #800000;">&#x2018;</span>):  seq =<span style="color: #000000;"> iter(seq)<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">while</span> True: <span style="color: #0000ff;">yield</span> [seq.next() <span style="color: #0000ff;">for</span> i <span style="color: #0000ff;">in</span><span style="color: #000000;"> xrange(size)]<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> seq=iter([1,2,3,4,5<span style="color: #000000;">])<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #008000;">#</span><span style="color: #008000;">r=group(seq,2)</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">#</span><span style="color: #008000;">print r.next()</span><br><span style="color: #008080;">11</span> <span style="color: #008000;">#</span><span style="color: #008000;">print r.next()</span><br><span style="color: #008080;">12</span> <span style="color: #008000;">#</span><span style="color: #008000;">print r.next() #&#x629B;&#x51FA;&#x5F02;&#x5E38;&#xFF0C;&#x56E0;&#x6B64;&#x6CA1;&#x6709;&#x751F;&#x6210;[5]</span></pre><br></p>
<p><pre></pre><br><br>&#xA0;</p>
<p><strong>2.#&#x7F13;&#x5B58;&#x51FD;&#x6570;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;&#x7684;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x3002;memoize</strong></p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> memoize:&#xFF08;web.py-0.111&#x5B9A;&#x4E49;&#x7684;&#x7248;&#x672C;&#xFF09;<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>init</strong></span><span style="color: #000000;">(self, func):<br></span><span style="color: #008080;"> 3</span>         self.func =<span style="color: #000000;"> func;<br></span><span style="color: #008080;"> 4</span>         self.cache =<span style="color: #000000;"> {}<br></span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>call</strong></span>(self, <em>a, **<span style="color: #000000;">k):<br></span><span style="color: #008080;"> 6</span>         key =<span style="color: #000000;"> (a, tuple(k.items()))<br></span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">if</span> key <span style="color: #0000ff;">not</span> <span style="color: #0000ff;">in</span><span style="color: #000000;"> self.cache:<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">print</span> <span style="color: #800000;">&#x201C;</span><span style="color: #800000;">no cahe</span><span style="color: #800000;">&#x201C;</span><br><span style="color: #008080;"> 9</span>             self.cache[key] = self.func(</em>a, **<span style="color: #000000;">k)<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">print</span> <span style="color: #800000;">&#x201C;</span><span style="color: #800000;">cache</span><span style="color: #800000;">&#x201C;</span><span style="color: #000000;">,self.cache[key]<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> self.cache[key]<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> test(a):<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> a<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> me_test=<span style="color: #000000;">memoize(test)<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> me_test(<span style="color: #800000;">&#x201C;</span><span style="color: #800000;">aa</span><span style="color: #800000;">&#x201C;</span><span style="color: #000000;">)<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> t=threading.Thread(target=me_test,args=(<span style="color: #800000;">&#x2018;</span><span style="color: #800000;">aa</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">,))<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">t.start()<br></span><span style="color: #008080;">26</span> t.join()</pre><br></p>
<div class="cnblogs_code">

<p><img src="http://www.zhouping.xin/wp-content/uploads/2016/04/ContractedBlock-1.gif" alt=""><img src="http://www.zhouping.xin/wp-content/uploads/2016/04/ExpandedBlockStart-1.gif" alt=""></p>
<p><div id="cnblogs_code_open_34ba046f-ede2-40f9-8fd2-47a8f37924ca" class="cnblogs_code_hide"></div></p>
<p><pre><span style="color: #0000ff;">class</span> Memoize:(web.py 0.37<span style="color: #000000;">)<br>    </span><span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><span style="color: #800000;"><br>    &#x2018;Memoizes&#x2019; a function, caching its return values for each input.<br>    If <code>expires</code> is specified, values are recalculated after <code>expires</code> seconds.<br>    If <code>background</code> is specified, values are recalculated in a separate thread.</span></pre></p>
<pre><code>    &amp;gt;&amp;gt;&amp;gt; calls = 0
    &amp;gt;&amp;gt;&amp;gt; def howmanytimeshaveibeencalled():
    ...     global calls
    ...     calls += 1
    ...     return calls
    &amp;gt;&amp;gt;&amp;gt; fastcalls = memoize(howmanytimeshaveibeencalled)
    &amp;gt;&amp;gt;&amp;gt; howmanytimeshaveibeencalled()
    1
    &amp;gt;&amp;gt;&amp;gt; howmanytimeshaveibeencalled()
    2
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    3
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    3
    &amp;gt;&amp;gt;&amp;gt; import time
    &amp;gt;&amp;gt;&amp;gt; fastcalls = memoize(howmanytimeshaveibeencalled, .1, background=False)
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    4
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    4
    &amp;gt;&amp;gt;&amp;gt; time.sleep(.2)
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    5
    &amp;gt;&amp;gt;&amp;gt; def slowfunc():
    ...     time.sleep(.1)
    ...     return howmanytimeshaveibeencalled()
    &amp;gt;&amp;gt;&amp;gt; fastcalls = memoize(slowfunc, .2, background=True)
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    6
    &amp;gt;&amp;gt;&amp;gt; timelimit(.05)(fastcalls)()
    6
    &amp;gt;&amp;gt;&amp;gt; time.sleep(.2)
    &amp;gt;&amp;gt;&amp;gt; timelimit(.05)(fastcalls)()
    6
    &amp;gt;&amp;gt;&amp;gt; timelimit(.05)(fastcalls)()
    6
    &amp;gt;&amp;gt;&amp;gt; time.sleep(.2)
    &amp;gt;&amp;gt;&amp;gt; timelimit(.05)(fastcalls)()
    7
    &amp;gt;&amp;gt;&amp;gt; fastcalls = memoize(slowfunc, None, background=True)
    &amp;gt;&amp;gt;&amp;gt; threading.Thread(target=fastcalls).start()
    &amp;gt;&amp;gt;&amp;gt; time.sleep(.01)
    &amp;gt;&amp;gt;&amp;gt; fastcalls()
    9
&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;
&lt;span style=&quot;color: #0000ff;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;__init__&lt;/span&gt;(self, func, expires=None, background=&lt;span style=&quot;color: #000000;&quot;&gt;True): 
    self.func &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; func
    self.cache &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; {}
    self.expires &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; expires
    self.background &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; background
    self.running &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; {}

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;__call__&lt;/span&gt;(self, *args, **&lt;span style=&quot;color: #000000;&quot;&gt;keywords):
    key &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; (args, tuple(keywords.items()))
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; self.running.get(key):
        self.running[key] &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; threading.Lock()
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;def&lt;/span&gt; update(block=&lt;span style=&quot;color: #000000;&quot;&gt;False):
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; self.running[key].acquire(block):
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
                self.cache[key] &lt;/span&gt;= (self.func(*args, **&lt;span style=&quot;color: #000000;&quot;&gt;keywords), time.time())
            &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;finally&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
                self.running[key].release()

    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; key &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; self.cache: 
        update(block&lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt;True)
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;elif&lt;/span&gt; self.expires &lt;span style=&quot;color: #0000ff;&quot;&gt;and&lt;/span&gt; (time.time() - self.cache[key][1]) &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; self.expires:
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; self.background:
            threading.Thread(target&lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt;update).start()
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
            update()
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; self.cache[key][0]
</code></pre><p>memoize =<span style="color: #000000;"> Memoize</span></p>
<p>re_compile = memoize(re.compile) <span style="color: #008000;">#</span><span style="color: #008000;">@@ threadsafe?</span><br>re_compile.<span style="color: #800080;"><strong>doc</strong></span> = <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><span style="color: #800000;"><br>A memoized version of re.compile.<br></span><span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br></p></div><br><span class="cnblogs_code_collapse">View Code</span><p></p>
<p><br>&#xA0;</p>
<hr>
<p><strong>3.&#x91CD;&#x5B9A;&#x5411;&#x8F93;&#x51FA;&#x5230;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4E2D;&#xFF08;&#x5728;&#x7C7B;&#x4E2D;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;write&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x4E8E;&#x91CD;&#x5B9A;&#x5411;&#xFF09;</strong></p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;"> 1</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> sys<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> A(object):<br></span><span style="color: #008080;"> 7</span>     text=<span style="color: #800000;">&#x2018;&#x2019;</span><br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> _outputter(object):<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> write(self, x):<br></span><span style="color: #008080;">11</span>         A.text+=<span style="color: #000000;">x<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> _oldstdout=<span style="color: #000000;">sys.stdout<br></span><span style="color: #008080;">14</span> sys.stdout=<span style="color: #000000;">_outputter()<br></span><span style="color: #008080;">15</span> <span style="color: #0000ff;">print</span> <span style="color: #800000;">&#x201C;</span><span style="color: #800000;">xxxxxxxx</span><span style="color: #800000;">&#x201C;</span><br><span style="color: #008080;">16</span> sys.stdout=<span style="color: #000000;">_oldstdout<br></span><span style="color: #008080;">17</span> <span style="color: #0000ff;">print</span> <span style="color: #800000;">&#x201C;</span><span style="color: #800000;">ctx:</span><span style="color: #800000;">&#x201C;</span>,A.text</pre><br><br>4.&#x6355;&#x83B7;&#x5F02;&#x5E38;&#xFF0C;&#x683C;&#x5F0F;&#x5316;&#x4FE1;&#x606F;&#x8F93;&#x51FA;&#x7684;&#x51FD;&#x6570;(&#x53EF;&#x4EE5;&#x501F;&#x7528;)&#xFF08;web.py-0111&#xFF09;</p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> djangoerror():<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> _get_lines_from_file(filename, lineno, context_lines):<br></span><span style="color: #008080;"> 3</span>         <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br><span style="color: #008080;"> 4</span> <span style="color: #800000;">        Returns context_lines before and after lineno from file.<br></span><span style="color: #008080;"> 5</span> <span style="color: #800000;">        Returns (pre_context_lineno, pre_context, context_line, post_context).<br></span><span style="color: #008080;"> 6</span>         <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 8</span>             source =<span style="color: #000000;"> open(filename).readlines()<br></span><span style="color: #008080;"> 9</span>             lower_bound = max(0, lineno -<span style="color: #000000;"> context_lines)<br></span><span style="color: #008080;">10</span>             upper_bound = lineno +<span style="color: #000000;"> context_lines<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>             #pre_context = [line.strip(<span style="color: #800000;">&#x2018;</span><span style="color: #800000;">\n</span><span style="color: #800000;">&#x2018;</span>) <span style="color: #0000ff;">for</span> line <span style="color: #0000ff;">in</span><span style="color: #000000;"> source[lower_bound:lineno]]<br>&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;  pre_context = [line.strip(&#x2018;\n&#x2019;) for line in source[lower_bound-1:lineno-1]]<br></span><span style="color: #008080;">13</span>             #context_line = source[lineno].strip(<span style="color: #800000;">&#x2018;</span><span style="color: #800000;">\n</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">)<br>&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;context_line = source[lineno-1].strip(&#x2018;\n&#x2019;)#&#x56E0;&#x4E3A;readlines&#x662F;&#x4ECE;&#x7D22;&#x5F15;0&#x5F00;&#x59CB;&#x7684;<br></span><span style="color: #008080;">14</span>             #post_context = [line.strip(<span style="color: #800000;">&#x2018;</span><span style="color: #800000;">\n</span><span style="color: #800000;">&#x2018;</span>) <span style="color: #0000ff;">for</span> line <span style="color: #0000ff;">in</span> source[lineno+1<span style="color: #000000;">:upper_bound]]<br>&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000; post_context = [line.strip(&#x2018;\n&#x2019;) for line in source[lineno:upper_bound]]<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> lower_bound, pre_context, context_line, post_context<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">except</span><span style="color: #000000;"> (OSError, IOError):<br></span><span style="color: #008080;">18</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> None, [], None, []<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     exception_type, exception_value, tb =<span style="color: #000000;"> sys.exc_info()<br></span><span style="color: #008080;">21</span>     frames =<span style="color: #000000;"> []<br></span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">while</span> tb <span style="color: #0000ff;">is</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> None:<br></span><span style="color: #008080;">23</span>         filename =<span style="color: #000000;"> tb.tb_frame.f_code.co_filename<br></span><span style="color: #008080;">24</span>         function =<span style="color: #000000;"> tb.tb_frame.f_code.co_name<br></span><span style="color: #008080;">25</span>         #lineno = tb.tb_lineno - 1 #&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x6240;&#x5728;&#x884C;&#x53F7;&#x663E;&#x793A;&#x4E0D;&#x5BF9;<br>&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;&#x3000;lineno = tb.tb_lineno<br><span style="color: #008080;">26</span>         pre_context_lineno, pre_context, context_line, post_context = _get_lines_from_file(filename, lineno, 7<span style="color: #000000;">)<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">        frames.append({<br></span><span style="color: #008080;">28</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">tb</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: tb,<br></span><span style="color: #008080;">29</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">filename</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: filename,<br></span><span style="color: #008080;">30</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">function</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: function,<br></span><span style="color: #008080;">31</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">lineno</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: lineno,<br></span><span style="color: #008080;">32</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">vars</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: tb.tb_frame.f_locals.items(),<br></span><span style="color: #008080;">33</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">id</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: id(tb),<br></span><span style="color: #008080;">34</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">pre_context</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: pre_context,<br></span><span style="color: #008080;">35</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">context_line</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: context_line,<br></span><span style="color: #008080;">36</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">post_context</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: post_context,<br></span><span style="color: #008080;">37</span>             <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">pre_context_lineno</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">: pre_context_lineno,<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">        })<br></span><span style="color: #008080;">39</span>         tb =<span style="color: #000000;"> tb.tb_next</span></pre></p>
<p>#frames &#x4FDD;&#x5B58;&#x8DDF;&#x8E2A;&#x5F02;&#x5E38;&#x56DE;&#x6EAF;&#x7684;&#x6BCF;&#x5C42; &#x4FE1;&#x606F;</p>
<p><pre><span style="color: #008080;">40</span>     lastframe = frames[-1<span style="color: #000000;">]<br></span><span style="color: #008080;">41</span>     urljoin =<span style="color: #000000;"> urlparse.urljoin<br></span><span style="color: #008080;">42</span>     input<em> =<span style="color: #000000;"> input()<br></span><span style="color: #008080;">43</span>     cookies</em> =<span style="color: #000000;"> cookies()<br></span><span style="color: #008080;">44</span>     context_ =<span style="color: #000000;"> context<br></span><span style="color: #008080;">45</span>     prettify =<span style="color: #000000;"> pprint.pformat<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span>     <span style="color: #008000;">#</span><span style="color: #008000;">&#x683C;&#x5F0F;&#x5316;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF0C;&#x65B9;&#x4FBF;&#x5728;&#x6A21;&#x677F;&#x5C55;&#x793A;</span><br><span style="color: #008080;">48</span>     frames &#x4EE5;&#x53CA;&#x4E0B;&#x9762;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x53EF;&#x4EE5; &#x7528;&#x4E8E;HTML&#x6A21;&#x677F;&#x7CFB;&#x7EDF;&#x5C55;&#x793A;<span style="color: #0000ff;"><br></span></pre><br><br>&#x7528;&#x4E8E;&#x5F02;&#x5E38;&#x5C55;&#x793A;&#x7684;HTML&#x6A21;&#x677F;&#xFF08;django&#x6846;&#x67B6;&#x91CC;&#x9762;&#x7684;&#xFF09;&#xFF1A;&#x57FA;&#x4E8E;Cheetah&#x6A21;&#x677F;&#x7CFB;&#x7EDF;(Cheetah&#x662F;&#x4E00;&#x4E2A;&#x7528;Python&#x5199;&#x7684;&#x6A21;&#x677F;&#x7CFB;&#x7EDF;&#x4E0E;&#x4EE3;&#x7801;&#x751F;&#x6210;&#x5DE5;&#x5177;)</p>
<p><div class="cnblogs_code"></div></p>
<div class="cnblogs_code">

<p><img src="http://www.zhouping.xin/wp-content/uploads/2016/04/ContractedBlock-1.gif" alt=""><img src="http://www.zhouping.xin/wp-content/uploads/2016/04/ExpandedBlockStart-1.gif" alt=""></p>
<p><div id="cnblogs_code_open_cdcb6080-0dab-4fc0-83b2-e584ae8aa931" class="cnblogs_code_hide"></div></p>
<p><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">def djangoerror():<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    def _get_lines_from_file(filename, lineno, context_lines):<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">        &#x201C;&#x201D;&#x201D;<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">        Returns context_lines before and after lineno from file.<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        Returns (pre_context_lineno, pre_context, context_line, post_context).<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        &#x201C;&#x201D;&#x201D;<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        try:<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            source = open(filename).readlines()<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            lower_bound = max(0, lineno - context_lines)<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">            upper_bound = lineno + context_lines<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #000000;">            pre_context = [line.strip(&#x2018;\n&#x2019;) for line in source[lower_bound:lineno]]<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            context_line = source[lineno-1].strip(&#x2018;\n&#x2019;)#&#x56E0;&#x4E3A;readlines&#x662F;&#x4ECE;&#x7D22;&#x5F15;0&#x5F00;&#x59CB;&#x7684;<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            post_context = [line.strip(&#x2018;\n&#x2019;) for line in source[lineno:upper_bound]]<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">            return lower_bound, pre_context, context_line, post_context<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        except (OSError, IOError):<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">            return None, [], None, []<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">    exception_type, exception_value, tb = sys.exc_info()<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    frames = []<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    while tb is not None:<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        filename = tb.tb_frame.f_code.co_filename<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">        function = tb.tb_frame.f_code.co_name<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        lineno = tb.tb_lineno #- 1#&#x4E0D;&#x51CF;&#x4E00;&#x663E;&#x793A;&#x7684;&#x662F;&#x62A5;&#x5F02;&#x5E38;&#x90A3;&#x53E5;&#x540E;&#x9762;&#x7684;&#x8BED;&#x53E5;&#xFF0C;&#x5728;_get_lines_from_file&#xFF0C;&#x5904;&#x7406;readlines&#x51CF;1&#xFF0C;&#x663E;&#x793A;&#x6B63;&#x5E38;<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        pre_context_lineno, pre_context, context_line, post_context = _get_lines_from_file(filename, lineno, 7)<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">        frames.append({<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">            &#x2018;tb&#x2019;: tb,<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">            &#x2018;filename&#x2019;: filename,<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">            &#x2018;function&#x2019;: function,<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">            &#x2018;lineno&#x2019;: lineno,<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">            &#x2018;vars&#x2019;: tb.tb_frame.f_locals.items(),<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            &#x2018;id&#x2019;: id(tb),<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">            &#x2018;pre_context&#x2019;: pre_context,<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">            &#x2018;context_line&#x2019;: context_line,<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            &#x2018;post_context&#x2019;: post_context,<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">            &#x2018;pre_context_lineno&#x2019;: pre_context_lineno,<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">        })<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">        tb = tb.tb<em>next<br></em></span><span style="color: #008080;">40</span> <span style="color: #000000;">    lastframe = frames[-1]<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">    urljoin = urlparse.urljoin<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">    input = input()<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">    cookies<em> = cookies()<br></em></span><span style="color: #008080;">44</span> <span style="color: #000000;">    context = context<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    prettify = pprint.pformat<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    #&#x683C;&#x5F0F;&#x5316;&#x7684;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#xFF0C;&#x65B9;&#x4FBF;&#x5728;&#x6A21;&#x677F;&#x5C55;&#x793A;<br></span><span style="color: #008080;">48</span>     return render(DJANGO_500_PAGE, asTemplate=True, isString=True)</pre><br></p></div><br><span class="cnblogs_code_collapse">View Code</span><p></p>
<p></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>web.py&#x4E2D;&#x5B9A;&#x4E49;&#x51E0;&#x79CD;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF1A;<br>1. Storage&#x7C7B;,&#x5728;utils&#x6587;&#x4EF6;&#x4E2D;&#x5B9A;&#x4E49;, &#x7C7B;&#x5B57;&#x5178;&#x5BF9;&#x8C61;,&#x4ECE;&#x5185;&#x5EFA;&#x5BF9;&#x8C61;dict&#x6D3E;&#x751F;&#xFF0C;&#x901A;&#x8FC7;&#x5B9E;&#x73B0;&#x7279;&#x6B8A;&#x65B9;&#x6CD5;&#xFF1A;<strong>getattr</strong>,<strong>setattr</strong>,<strong>delattr</strong>,<br>&#x4EE5;&#x81F3;&#x4E8E;&#x50CF;&#x8BBE;&#x7F6E;&#x3001;&#x83B7;&#x53D6;&#x3001;&#x5220;&#x9664;&#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x548C;&#x503C;&#x4E00;&#x6837;&#x8BBE;&#x7F6E;&#x3001;&#x83B7;&#x53D6;&#x3001;&#x5220;&#x9664;&#x5B57;&#x5178;&#x7684;&#x952E;&#x548C;&#x503C;&#x3002;</p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #0000ff;">class</span><span style="color: #000000;"> Storage(dict):<br>    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>getattr</strong></span><span style="color: #000000;">(self, key):<br>        </span><span style="color: #0000ff;">try</span><span style="color: #000000;">:<br>            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> self[key]<br>        </span><span style="color: #0000ff;">except</span><span style="color: #000000;"> KeyError, k:<br>            </span><span style="color: #0000ff;">raise</span><span style="color: #000000;"> AttributeError, k</span></pre></p>
<pre><code>&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;__setattr__&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(self, key, value): 
    self[key] &lt;/span&gt;=&lt;span style=&quot;color: #000000;&quot;&gt; value

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;__delattr__&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(self, key):
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;try&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;del&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; self[key]
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;except&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; KeyError, k:
        &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;raise&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; AttributeError, k

&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;__repr__&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;(self):     
    &lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt; + dict.&lt;span style=&quot;color: #800080;&quot;&gt;__repr__&lt;/span&gt;(self) + &lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;&apos;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;
</code></pre><p><br>web.config &#x521D;&#x59CB;&#x5316;&#x7684;&#x662F;&#x4E00;&#x4E2A;storge&#x5BF9;&#x8C61;</p>
<p>2.ThreadedDict&#x7C7B;&#xFF0C;&#x5728;utils&#x6587;&#x4EF6;&#x4E2D;&#x5B9A;&#x4E49;&#xFF0C;&#x7EBF;&#x7A0B;&#x5B57;&#x5178;&#xFF0C;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;,&#x8BE5;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x5B58;&#x5728;&#x4E8E;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x5176;&#x5C5E;&#x6027;&#x503C; &#x5728;&#x6BCF;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x4E2D;&#x662F;&#x72EC;&#x7ACB;&#x7684;</p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;"> 1</span>     <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br><span style="color: #008080;"> 2</span> <span style="color: #800000;">    Thread local storage.<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #800000;">        &gt;&gt;&gt; d = ThreadedDict()<br></span><span style="color: #008080;"> 5</span> <span style="color: #800000;">        &gt;&gt;&gt; d.x = 1<br></span><span style="color: #008080;"> 6</span> <span style="color: #800000;">        &gt;&gt;&gt; d.x<br></span><span style="color: #008080;"> 7</span> <span style="color: #800000;">        1<br></span><span style="color: #008080;"> 8</span> <span style="color: #800000;">        &gt;&gt;&gt; import threading<br></span><span style="color: #008080;"> 9</span> <span style="color: #800000;">        &gt;&gt;&gt; def f(): d.x = 2<br></span><span style="color: #008080;">10</span> <span style="color: #800000;">        &#x2026;<br></span><span style="color: #008080;">11</span> <span style="color: #800000;">        &gt;&gt;&gt; t = threading.Thread(target=f)<br></span><span style="color: #008080;">12</span> <span style="color: #800000;">        &gt;&gt;&gt; t.start()<br></span><span style="color: #008080;">13</span> <span style="color: #800000;">        &gt;&gt;&gt; t.join()<br></span><span style="color: #008080;">14</span> <span style="color: #800000;">        &gt;&gt;&gt; d.x<br></span><span style="color: #008080;">15</span> <span style="color: #800000;">        1<br></span><span style="color: #008080;">16</span>     <span style="color: #800000;">&#x201C;&#x201D;&#x201D;<br>&#x5F53;&#x524D;&#x7248;&#x672C;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;&#xFF08;</span>&#x4F9D;&#x8D56;&#x4E8E;threading&#x6A21;&#x5757;&#x7684;local &#xFF08;&#x5728;python23.py &#x6709;&#x4E2A;&#x4E13;&#x95E8;&#x5BF9;python2.3&#x5B9E;&#x73B0;&#x7684;threadlocal&#xFF09;<span style="color: #800000;">&#xFF09;</span></pre></p>
<p><pre></pre></p>
<p><div class="cnblogs_code"></div></p>
<p><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> threading<br></span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">from</span> threading <span style="color: #0000ff;">import</span><span style="color: #000000;"> local as threadlocal<br></span><span style="color: #008080;">  3</span><br><span style="color: #008080;">  4</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> threadlocal(object):<br></span><span style="color: #008080;">  5</span>     <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><span style="color: #800000;">Implementation of threading.local for python2.3.<br></span><span style="color: #008080;">  6</span>     <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>getattribute</strong></span><span style="color: #000000;">(self, name):<br></span><span style="color: #008080;">  8</span>         <span style="color: #0000ff;">if</span> name == <span style="color: #800000;">&#x201C;</span><span style="color: #800000;"><strong>dict</strong></span><span style="color: #800000;">&#x201C;</span><span style="color: #000000;">:<br></span><span style="color: #008080;">  9</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> threadlocal._getd(self)<br></span><span style="color: #008080;"> 10</span>         <span style="color: #0000ff;">else</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 11</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 12</span>                 <span style="color: #0000ff;">return</span> object.<span style="color: #800080;"><strong>getattribute</strong></span><span style="color: #000000;">(self, name)<br></span><span style="color: #008080;"> 13</span>             <span style="color: #0000ff;">except</span><span style="color: #000000;"> AttributeError:<br></span><span style="color: #008080;"> 14</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 15</span>                     <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">[name]<br></span><span style="color: #008080;"> 16</span>                 <span style="color: #0000ff;">except</span><span style="color: #000000;"> KeyError:<br></span><span style="color: #008080;"> 17</span>                     <span style="color: #0000ff;">raise</span><span style="color: #000000;"> AttributeError, name<br></span><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>setattr</strong></span><span style="color: #000000;">(self, name, value):<br></span><span style="color: #008080;"> 20</span>         self.<span style="color: #800080;"><strong>dict</strong></span>[name] =<span style="color: #000000;"> value<br></span><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>delattr</strong></span><span style="color: #000000;">(self, name):<br></span><span style="color: #008080;"> 23</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 24</span>             <span style="color: #0000ff;">del</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">[name]<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">except</span><span style="color: #000000;"> KeyError:<br></span><span style="color: #008080;"> 26</span>             <span style="color: #0000ff;">raise</span><span style="color: #000000;"> AttributeError, name<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> _getd(self):<br></span><span style="color: #008080;"> 29</span>         t =<span style="color: #000000;"> threading.currentThread()<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> hasattr(t, <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">_d</span><span style="color: #800000;">&#x2018;</span><span style="color: #000000;">):<br></span><span style="color: #008080;"> 31</span>             <span style="color: #008000;">#</span><span style="color: #008000;"> using <strong>dict</strong> of thread as thread local storage</span><br><span style="color: #008080;"> 32</span>             t._d =<span style="color: #000000;"> {}<br></span><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span>         _id =<span style="color: #000000;"> id(self)<br></span><span style="color: #008080;"> 35</span>         <span style="color: #008000;">#</span><span style="color: #008000;"> there could be multiple instances of threadlocal.</span><br><span style="color: #008080;"> 36</span>         <span style="color: #008000;">#</span><span style="color: #008000;"> use id(self) as key</span><br><span style="color: #008080;"> 37</span>         <span style="color: #0000ff;">if</span> _id <span style="color: #0000ff;">not</span> <span style="color: #0000ff;">in</span><span style="color: #000000;"> t._d:<br></span><span style="color: #008080;"> 38</span>             t._d[_id] =<span style="color: #000000;"> {}<br></span><span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> t._d[_id]<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ThreadedDict(threadlocal):<br></span><span style="color: #008080;"> 42</span><br><span style="color: #008080;"> 43</span>     _instances =<span style="color: #000000;"> set()<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>init</strong></span><span style="color: #000000;">(self):<br></span><span style="color: #008080;"> 46</span> <span style="color: #000000;">        ThreadedDict._instances.add(self)<br></span><span style="color: #008080;"> 47</span><br><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>del</strong></span><span style="color: #000000;">(self):<br></span><span style="color: #008080;"> 49</span> <span style="color: #000000;">        ThreadedDict._instances.remove(self)<br></span><span style="color: #008080;"> 50</span><br><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>hash</strong></span><span style="color: #000000;">(self):<br></span><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> id(self)<br></span><span style="color: #008080;"> 53</span><br><span style="color: #008080;"> 54</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> clear_all():<br></span><span style="color: #008080;"> 55</span>         <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><span style="color: #800000;">Clears all ThreadedDict instances.<br></span><span style="color: #008080;"> 56</span>         <span style="color: #800000;">&#x201C;&#x201D;&#x201D;</span><br><span style="color: #008080;"> 57</span>         <span style="color: #0000ff;">for</span> t <span style="color: #0000ff;">in</span><span style="color: #000000;"> list(ThreadedDict._instances):<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">            t.clear()<br></span><span style="color: #008080;"> 59</span>     clear_all =<span style="color: #000000;"> staticmethod(clear_all)<br></span><span style="color: #008080;"> 60</span><br><span style="color: #008080;"> 61</span>     <span style="color: #008000;">#</span><span style="color: #008000;"> Define all these methods to more or less fully emulate dict &#x2013; attribute access</span><br><span style="color: #008080;"> 62</span>     <span style="color: #008000;">#</span><span style="color: #008000;"> is built into threading.local.</span><br><span style="color: #008080;"> 63</span><br><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>getitem</strong></span><span style="color: #000000;">(self, key):<br></span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">[key]<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>setitem</strong></span><span style="color: #000000;">(self, key, value):<br></span><span style="color: #008080;"> 68</span>         self.<span style="color: #800080;"><strong>dict</strong></span>[key] =<span style="color: #000000;"> value<br></span><span style="color: #008080;"> 69</span><br><span style="color: #008080;"> 70</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>delitem</strong></span><span style="color: #000000;">(self, key):<br></span><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">del</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">[key]<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>contains</strong></span><span style="color: #000000;">(self, key):<br></span><span style="color: #008080;"> 74</span>         <span style="color: #0000ff;">return</span> key <span style="color: #0000ff;">in</span> self.<span style="color: #800080;"><strong>dict</strong></span><br><span style="color: #008080;"> 75</span><br><span style="color: #008080;"> 76</span>     has_key = <span style="color: #800080;"><strong>contains</strong></span><br><span style="color: #008080;"> 77</span><br><span style="color: #008080;"> 78</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> clear(self):<br></span><span style="color: #008080;"> 79</span>         self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.clear()<br></span><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> copy(self):<br></span><span style="color: #008080;"> 82</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.copy()<br></span><span style="color: #008080;"> 83</span><br><span style="color: #008080;"> 84</span>     <span style="color: #0000ff;">def</span> get(self, key, default=<span style="color: #000000;">None):<br></span><span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.get(key, default)<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> items(self):<br></span><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.items()<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> iteritems(self):<br></span><span style="color: #008080;"> 91</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.iteritems()<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> keys(self):<br></span><span style="color: #008080;"> 94</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.keys()<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> iterkeys(self):<br></span><span style="color: #008080;"> 97</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.iterkeys()<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span>     iter =<span style="color: #000000;"> iterkeys<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> values(self):<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.values()<br></span><span style="color: #008080;">103</span><br><span style="color: #008080;">104</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> itervalues(self):<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.itervalues()<br></span><span style="color: #008080;">106</span><br><span style="color: #008080;">107</span>     <span style="color: #0000ff;">def</span> pop(self, key, <em><span style="color: #000000;">args):<br></span><span style="color: #008080;">108</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span>.pop(key, </em><span style="color: #000000;">args)<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> popitem(self):<br></span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.popitem()<br></span><span style="color: #008080;">112</span><br><span style="color: #008080;">113</span>     <span style="color: #0000ff;">def</span> setdefault(self, key, default=<span style="color: #000000;">None):<br></span><span style="color: #008080;">114</span>         <span style="color: #0000ff;">return</span> self.<span style="color: #800080;"><strong>dict</strong></span><span style="color: #000000;">.setdefault(key, default)<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span>     <span style="color: #0000ff;">def</span> update(self, <em>args, **<span style="color: #000000;">kwargs):<br></span><span style="color: #008080;">117</span>         self.<span style="color: #800080;"><strong>dict</strong></span>.update(</em>args, **<span style="color: #000000;">kwargs)<br></span><span style="color: #008080;">118</span><br><span style="color: #008080;">119</span>     <span style="color: #0000ff;">def</span> <span style="color: #800080;"><strong>repr</strong></span><span style="color: #000000;">(self):<br></span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">return</span> <span style="color: #800000;">&#x2018;</span><span style="color: #800000;">&#x2018;</span> % self.<span style="color: #800080;"><strong>dict</strong></span><br><span style="color: #008080;">121</span><br><span style="color: #008080;">122</span>     <span style="color: #800080;"><strong>str</strong></span> = <span style="color: #800080;"><strong>repr</strong><br>&#x8BE5;&#x7C7B;&#x7EE7;&#x627F;&#x81EA; threading.local &#x7C7B;&#xFF0C;&#x7136;&#x540E;&#x5B9A;&#x5236;&#x6210;&#x7C7B;&#x5B57;&#x5178;&#x5BF9;&#x8C61;<br></span></pre><br></p>
<p><pre></pre><br>web.py 0.111&#x4E2D;&#x7684;&#x5B9E;&#x73B0;&#x3002;&#x4F9D;&#x8D56;&#x4E8E;threading&#x4E2D;&#x7684;currentThread&#xFF1A;(&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x90FD;&#x5FC5;&#x987B;&#x7528;&#x7EBF;&#x7A0B;id&#x4F5C;&#x4E3A;&#x952E;&#x66F4;&#x65B0;&#x5168;&#x5C40;_context&#x5B57;&#x5178;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x4FBF;&#x7EBF;&#x7A0B;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x7EBF;&#x7A0B;id&#x8BBF;&#x95EE;/&#x8BBE;&#x7F6E;&#x81EA;&#x5DF1;&#x7684;&#x5C5E;&#x6027;)</p>
<p><div class="cnblogs_Highlighter"></div></p>
<p><div class="cnblogs_Highlighter"></div></p>
<p><pre class="brush:python;gutter:true;">class threadeddict:<br>    def <strong>init</strong>(self, d):<br>        self.<strong>dict</strong>[&#x2018;_threadeddict<strong>d&#x2019;] = d #&#x76F8;&#x5F53;&#x4E8E;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;</strong>d&#x79C1;&#x6709;&#x5C5E;&#x76F8;</pre></p>
<pre><code>def __getattr__(self, a): 
    return getattr(self.__d[currentThread()], a)

def __getitem__(self, i): 
    return self.__d[currentThread()][i]

def __setattr__(self, a, v): 
    return setattr(self.__d[currentThread()], a, v)

def __setitem__(self, i, v): 
    self.__d[currentThread()][i] = v
</code></pre><p>###&#x4F7F;&#x7528;&#x793A;&#x4F8B;####<br>   _context = {currentThread():Storage()}<br>    mydata=threadeddict(_context)<br>    mydata.number=345<br>    print mydata.number</p>
<pre><code>def f():
    _context[currentThread()]= Storage()#&#x6DFB;&#x52A0;&#x952E;&#x4F4D;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;id&#x7684;&#x9879;
    mydata.number=22
    print mydata.number

t=threading.Thread(target=f)
t.start()
t.join()
print mydata.number
</code></pre><hr>
<p>&gt;345<br>&gt;22<br>&gt;345<br><br><br><br>&#xA0;</p>
<hr>
<p>1. application&#x7C7B;</p>
<p>&#x94A9;&#x5B50;&#x51FD;&#x6570;:<br>loadhook(func) &#x5728;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x4E4B;&#x524D; func()<br>unloadhook(func) &#x5728;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x4E4B;&#x540E; func()</p>
<p>app.add_processor(processor) processor&#x7684;&#x53C2;&#x6570;&#x4E3A;handler:&#x8BF7;&#x6C42;&#x5904;&#x7406;&#x51FD;&#x6570;</p>
<p>web.config.debug=False &#x8BF7;&#x6C42;&#x5904;&#x7406;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x91CD;&#x65B0;&#x52A0;&#x8F7D; app&#x6240;&#x5728;&#x6A21;&#x5757;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;web.py&#x81EA;&#x5E26;&#x7684;&#x670D;&#x52A1;&#x5668;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;True<br>&#x5728; wsgi.py &#x4E2D;web.config.setdefault(&#x2018;debug&#x2019;, _is_dev_mode())&#x8BBE;&#x7F6E;debug&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#xFF0C;_is_dev_mode&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x5F00;&#x53D1;&#x73AF;&#x5883;</p>
<p>&#xA0;</p>
<p><strong>wsgifunc</strong> &#x65B9;&#x6CD5;,&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x517C;&#x5BB9;WSGI&#x7684;application&#x51FD;&#x6570; ,&#x63A5;&#x53D7;&#x4E00;&#x7CFB;&#x5217;&#x4E2D;&#x95F4;&#x4EF6;middleware&#x53C2;&#x6570;</p>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;</p>
<p>peep(iterator)  &#x2018;&#x2019;&#x2019;Peeps into an iterator by doing an iteration and returns an equivalent iterator.&#x2019;&#x2019;&#x2019;</p>
<p>is_generator(x) &#x5224;&#x65AD;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x662F;&#x4E00;&#x4E2A;&#x751F;&#x6210;&#x5668;</p>
<p>wsgi</p>
<p>&#xA0;</p>
<p>&#xA0;</p>
<p><strong>_cleanup</strong> &#x65B9;&#x6CD5; &#x6E05;&#x9664;&#x6240;&#x6709;ThreadedDict&#x7684;&#x662F;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;&#xFF08;&#x6BCF;&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5B57;&#x5178;&#x5BF9;&#x8C61;&#x90FD;&#x4F1A;&#x88AB;&#x4FDD;&#x5B58;&#xFF09;</p>
<p><strong>load</strong> &#x65B9;&#x6CD5;&#xFF0C;&#x7528;env&#x5B57;&#x5178;&#x53D8;&#x91CF;&#x521D;&#x59CB;&#x5316;web.ctx&#x5404;&#x9879;&#x5C5E;&#x6027;&#x503C;. &#x5728;wsgiffunc&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;wsgi&#x51FD;&#x6570;&#x4E2D;&#x8C03;&#x7528;</p>
<p>&#xA0;</p>
<p>&#x9644;&#x2014;&#x2014;&#x2014;&#x2014;</p>
<p>_os.stat(mod.<strong>file</strong>).st<em>mtime os.stat()&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x7684;&#x76F8;&#x5173;&#x5C5E;&#x6027;</em></p>
<p><em>itertools.chain &#x5206;&#x522B;&#x8FED;&#x4EE3;&#x591A;&#x4E2A;&#x5E8F;&#x5217;&#x6216;&#x8FED;&#x4EE3;&#x5668;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x8FDE;&#x63A5;&#x5728;&#x4E00;&#x8D77;&#x8F6C;&#x6362;&#x6210;&#x4E00;&#x4E2A;&#x8FED;&#x4EE3;&#x5668;</em></p>
<p>_sys._getframe(1).f<em>locals  </em></p>
<p><span style="font-size: 12px;"><em>Return a frame object from the call stack. If optional integer depth is</em></span><br><span style="font-size: 12px;"><em> given, return the frame object that many calls below the top of the stack.</em></span><br><span style="font-size: 12px;"><em> If that is deeper than the call stack, ValueError is raised. The default</em></span><br><span style="font-size: 12px;"><em> for depth is zero, returning the frame at the top of the call stack.</em></span></p>
<p>&#xA0;</p>
<p>&#xA0;</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2014/09/17/html-e6-a0-87-e7-ad-be/" rel="next" title="HTML标签">
                <i class="fa fa-chevron-left"></i> HTML标签
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2014/12/22/storm-e7-9b-b8-e5-85-b3-e6-8a-80-e6-9c-af/" rel="prev" title="storm相关技术">
                storm相关技术 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/"
     data-title="web.py源码(持续更新)"
     data-content=""
     data-url="http://notes.zhouping.xin/2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/"
           data-title="web.py源码(持续更新)" data-url="http://notes.zhouping.xin/2014/12/17/web-py-e6-ba-90-e7-a0-81-e6-8c-81-e7-bb-ad-e6-9b-b4-e6-96-b0/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar-zp.png"
               alt="Chow" />
          <p class="site-author-name" itemprop="name">Chow</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">123</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/aveenzhou" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number">1.</span> <span class="nav-text"></span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-camera"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chow</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  <a class="theme-link" href="https://github.com/aveenzhou"> 感谢github提供的免费空间 </a>
  感谢iissnan's主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"chow-notes"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  










  
  

  

  

  

  


</body>
</html>
